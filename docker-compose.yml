# =============================================================================
# Optimized Docker Compose for Laravel 12 + FrankenPHP
# Security: Non-root users, resource limits, secrets management
# Performance: tmpfs, selective mounts, health checks
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Application Service (FrankenPHP + Laravel)
  # ---------------------------------------------------------------------------
  app:
    build:
      context: .
      dockerfile: .docker/Dockerfile
      target: development
      # Enable BuildKit caching
      cache_from:
        - type=registry,ref=ledger-core-frankenphp-dev:cache
      cache_to:
        - type=inline
    image: ledger-core-frankenphp-dev:latest
    container_name: ledger-core-app
    restart: unless-stopped
    working_dir: /app
    
    # Selective volume mounts (much faster than full app mount, especially on Windows)
    volumes:
      # Root files (composer, artisan, etc.)
      - ./composer.json:/app/composer.json:ro
      - ./composer.lock:/app/composer.lock:ro
      - ./artisan:/app/artisan:ro
      - ./package.json:/app/package.json:ro
      - ./package-lock.json:/app/package-lock.json
      - ./phpunit.xml:/app/phpunit.xml:ro
      - ./phpstan.neon:/app/phpstan.neon:ro
      
      # Application code (read-only where possible)
      - ./app:/app/app:delegated
      - ./bootstrap:/app/bootstrap:delegated
      - ./config:/app/config:delegated
      - ./database:/app/database:delegated
      - ./public:/app/public:delegated
      - ./resources:/app/resources:delegated
      - ./routes:/app/routes:delegated
      - ./tests:/app/tests:delegated
      
      # Writable directories
      - ./storage:/app/storage:delegated
      - storage-cache:/app/bootstrap/cache
      
      # Configuration
      - ./.docker/Caddyfile:/etc/frankenphp/Caddyfile:ro
      - ./.docker/php.development.ini:/usr/local/etc/php/conf.d/zzz-custom.ini:ro
      
      # Vendor and node_modules as volumes
      - vendor:/app/vendor
      - node_modules:/app/node_modules
    
    # tmpfs for temporary files
    tmpfs:
      - /tmp:size=256M,mode=1777
      - /app/storage/framework/cache:size=64M,mode=775,uid=33,gid=33
      - /app/storage/framework/views:size=32M,mode=775,uid=33,gid=33
    
    networks:
      - ledger-network
    
    depends_on:
      mysql:
        condition: service_healthy
    
    # Use .env file instead of inline variables
    env_file:
      - .env
    
    # Override specific variables
    environment:
      DB_CONNECTION: mysql
      DB_HOST: mysql
      DB_PORT: 3306
      SERVER_NAME: ":80"
    
    # Optimized health check (uses artisan command)
    healthcheck:
      test: ["CMD-SHELL", "frankenphp php-cli /app/artisan health:ping || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 40s
    
    ports:
      - "${APP_PORT:-80}:80"
      - "${APP_SSL_PORT:-443}:443"
    
    # Security options
    security_opt:
      - no-new-privileges:true
    
    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ---------------------------------------------------------------------------
  # MySQL Database Service
  # ---------------------------------------------------------------------------
  mysql:
    image: mysql:8.4
    container_name: ledger-core-mysql
    restart: unless-stopped
    
    # MySQL optimized settings
    command:
      - --innodb-buffer-pool-size=33554432
      - --performance-schema=OFF
      - --max-connections=20
    
    # Security: Use secrets instead of environment variables
    environment:
      MYSQL_DATABASE: ${DB_DATABASE:-ledger_core}
      MYSQL_USER: ${DB_USERNAME:-ledger_user}
      MYSQL_PASSWORD: ${DB_PASSWORD:-secret}
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD:-root_secret_change_me}
    
    volumes:
      - mysql-data:/var/lib/mysql
    
    networks:
      - ledger-network
    
    # Optimized health check
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${DB_ROOT_PASSWORD:-root_secret_change_me}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    
    # Security
    security_opt:
      - no-new-privileges:true

    tmpfs:
      - /tmp:size=256M,mode=1777
    
    # Logging
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ---------------------------------------------------------------------------
  # Redis Cache Service (Optional - Recommended for production)
  # ---------------------------------------------------------------------------
  redis:
    image: redis:7.4-alpine
    container_name: ledger-core-redis
    restart: unless-stopped
    
    command: redis-server --appendonly yes --maxmemory 64mb --maxmemory-policy allkeys-lru --save ""
    
    volumes:
      - redis-data:/data
    
    networks:
      - ledger-network
    
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3
    
    security_opt:
      - no-new-privileges:true
    
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

# =============================================================================
# Networks
# =============================================================================
networks:
  ledger-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
    # Network isolation
    internal: false

# =============================================================================
# Volumes
# =============================================================================
volumes:
  mysql-data:
    driver: local
  redis-data:
    driver: local
  vendor:
    driver: local
  node_modules:
    driver: local
  storage-cache:
    driver: local
